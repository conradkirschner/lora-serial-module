<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lora Serial Interface</title>
    <style>
        .disabled{
            background: black;
            color:white;
        }
        .enabled {
            color:black;
            background: #bfbdbd;
        }
        .blacklist-item {
            margin: 5px;
            padding: 5px;
        }
        .red-blacklist-status {
            box-shadow: rgb(214, 3, 3) 0px 0px 0px 3px;
        }
        .green-blacklist-status {
            box-shadow: rgb(91, 214, 3) 0px 0px 0px 3px;
        }
        .hidden {
            display:none;
        }
        .full-log-toggle{
            color: inherit
        }
        .blacklist-container{
            display: inline-flex;
        }
        .serial-console-log-container{
            box-shadow: rgba(0, 0, 0, 0.05) 0px 0px 0px 1px;
            overflow: scroll;
            overflow-x: hidden;
        }
        .serial-console-container{
            border: 1px solid lightgray;
            box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
            width: 750px;
            padding: 5px;
            margin: 15px;
            height: 300px;
            grid-template-rows: 3rem 4rem 1fr 1fr;
            display: inline-grid;
        }
        .serial-console-close-button {
            margin: 5px 10px 5px 10px;
            padding: 5px;
            background: red;
            border: 1px solid lightcoral;
        }
        .serial-console-header{
            display: inline-flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            border-bottom: 1px solid lightgray;
            margin-bottom: 5px;
        }
        .serial-console-footer {
            display: inline-flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            border-top: 1px solid lightgray;
            margin-top: 5px;
            padding-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div>
             <input id="spawnConsoleButton-input" type="number" min="1" max="20"><button id="spawnConsoleButton">Create new instance to</button>
        </div>
    </header>
    <main>

    </main>
    <script>

        window.getQuerySelector = (id, name) => {
            return `#${id} [data-id="${name}"]`
        }
        /**
         * Header Handler
         **/
        const $spawnButton = document.getElementById('spawnConsoleButton');
        const $spawnButtonInput = document.getElementById('spawnConsoleButton-input');
        $spawnButton.addEventListener('click', () => {
            const main = document.getElementsByTagName('main')[0];
            const serialConsoleId = createSerialConsole(main,$spawnButtonInput.value);
            serialConsoleIds[serialConsoleId.id] = serialConsoleId
            attachEvents(serialConsoleId.id)
        })
        /**
         * Serial Console Handler
         */
        window.serialConsoleIds = {};
        document.addEventListener("DOMContentLoaded", function(event) {
            const main = document.getElementsByTagName('main')[0];
            const serialConsoleId = createSerialConsole(main,11);
            serialConsoleIds[serialConsoleId.id] = serialConsoleId
            attachEvents(serialConsoleId.id)
            const serialConsoleId1 = createSerialConsole(main,15);
            serialConsoleIds[serialConsoleId1.id] = serialConsoleId1
        });
        const attachEvents = (id) => {
            const $log = document.querySelector(getQuerySelector(id,'log'));
            const $deviceId = document.querySelector(getQuerySelector(id, 'device-id'));
            const $readonlyLabel = document.querySelector(getQuerySelector(id, 'readonly-label'));
            const $blacklist = document.querySelector(getQuerySelector(id ,'blacklist'));
            const $lanContainer = document.querySelector(getQuerySelector(id, 'is-lan'));
            const $fullLogToggleContainer = document.querySelector(getQuerySelector(id, 'full-log-toggle'));
            const $fullLogToggleButton = document.querySelector(getQuerySelector(id, 'readonly-toggle-full-log'));

            if (window.serialConsoleIds[id].actions === undefined){
                setTimeout(()=> {
                    attachEvents(id);
                }, 300);
                return;
            }
            const currentSerialConsole = window.serialConsoleIds[id];
            currentSerialConsole.elements.$fullLogToggleButton.addEventListener('click', ()=> {
                currentSerialConsole.actions.toggleFullLog();
            })
            console.log(window.serialConsoleIds[id].actions.getDeviceId());
        }
    </script>
<script>

    /**
     * @var renderInto HTMLElement
     * @param renderInto
     **/
    function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
            result += characters.charAt(Math.floor(Math.random() *
                charactersLength));
        }
        return result;
    }

const createSerialConsole = (renderInto, connectToDeviceId) => {
    /**
     * first create container
     **/
    const id = makeid(5);
    const serialConsole = document.createElement('div');
    serialConsole.id = id;
    serialConsole.classList.add('serial-console-container')
    serialConsole.innerHTML = `
            <div data-id="header" class="serial-console-header">
                <span>Serial Console -  <span data-id="device-id">...</span></span>
                 <span data-id="readonly-label" class="readonly-label hidden">readonly <a class="full-log-toggle"  href="javascript:false" data-id="full-log-toggle"> (active full log)</a></span>
                 <span data-id="close-button" class="serial-console-close-button">[CLOSE]</span>
            </div>
            <div data-id="status-bar">
                <div> Ist im Wlan: <span data-id="is-lan">...</span></div>
                <div> Blacklist: <span class="blacklist-container" data-id="blacklist">...</span></div>
            </div>
            <div class="serial-console-log-container">
                Log:
                <div data-id="log"></div>
            </div>
            <div data-id="footer" class="serial-console-footer">
            <div data-id="send-text-serial">
                <div>Serial Text Input</div> <input data-id="send-text-serial-input" type="text">
                <button data-id="send-text-serial-button">senden</button>
            </div>
             <div data-id="show-packages-container">
                <button data-id="show-packages-button">Show packages</button>
            </div>
        </div>
    `;

    renderInto.appendChild(serialConsole);
    setTimeout(()=> {
    const connection = new WebSocket('ws://localhost:8001/'+connectToDeviceId, ['soap', 'xmpp']);
    const log = [];
    let deviceId = undefined;
    let isReadOnly = undefined;
    let blacklist = undefined;
    let lan = undefined;
    let isFullLog = false;
    const $log = document.querySelector(getQuerySelector(id,'log'));
    const $deviceId = document.querySelector(getQuerySelector(id, 'device-id'));
    const $readonlyLabel = document.querySelector(getQuerySelector(id, 'readonly-label'));
    const $blacklist = document.querySelector(getQuerySelector(id ,'blacklist'));
    const $lanContainer = document.querySelector(getQuerySelector(id, 'is-lan'));
    const $fullLogToggleButton = document.querySelector(getQuerySelector(id, 'full-log-toggle'));
    const $container = document.querySelector('#'+ id);
    const elements = {
        $log,
        $deviceId,
        $readonlyLabel,
        $blacklist,
        $lanContainer,
        $fullLogToggleButton,
        $container,
    }
    console.log($log);
    const toggleFullLog = () => {
        if (!isFullLog) {
            connection.send('@@@UPGRADE@@@');
            $fullLogToggleButton.innerText = '(active full log)';
            isFullLog = true;
        } else {
            connection.send('@@@DOWNGRADE@@@');
            $fullLogToggleButton.innerText = '(deactive full log)';
            isFullLog = false;
        }

    }
    const setReadOnly = () => {
        /**
         * Upgrade Protocol
         * @type {boolean}
         */
        toggleFullLog();
        isReadOnly = true;
        $container.classList.add('disabled');
        $container.classList.remove('enabled');
        $readonlyLabel.classList.remove('hidden');
    }
    const getReadOnlyStatus = () => {
        return isReadOnly;
    }
    const setReadOnlySendedRequest = (sended) => {
        const newLogEntry = document.createElement('div');
        let showText = 'BINARY PACKAGE:  [';
        if (sended[0] === 'A'  && sended[1] === 'T' ) {
            showText = sended;
        } else  {
            for (let i = 0; i < sended.length; i++) {
                try {
                    showText += parseInt(sended.charCodeAt(i).toString(2), 2) + '-';
                } catch (e) {
                    showText += sended[i];
                }
            }
            showText = showText.substring(0, showText.length - 1) + ']';
        }
        newLogEntry.innerText = showText;
        $log.appendChild(newLogEntry)
        return ;
    }

    const setBlacklist = (newBlacklist) => {
        $blacklist.innerHTML = '';
        for (let i = 1; i <= 20; i++) {
            const blackListBoxes = document.createElement('div');
            blackListBoxes.classList.add('blacklist-item');
            blackListBoxes.innerText = (i).toString();
            if (newBlacklist.indexOf(i.toString()) === -1) {
                blackListBoxes.classList.add('green-blacklist-status');
            } else {
                blackListBoxes.classList.add('red-blacklist-status');
            }
            blackListBoxes.addEventListener('click', (event) => {
                const blackListId = event.target.innerText;
                const index = newBlacklist.indexOf(blackListId);
                const removedItem = newBlacklist.splice(index, 1);
                connection.send('@@@BLACKLIST@@@'+newBlacklist.join(','))

                debugger;
            })
            $blacklist.appendChild(blackListBoxes)
        }
    }
    const getBlacklist = () => {
        return blacklist;
    }
    const setLan = (value) => {
        lan = value;
        if (value === 'true') {
            $lanContainer.innerText = '✓'
            return;
        }
        $lanContainer.innerText = '❌';
    }
    const getLan = () => {
        return lan;
    }
    const setDeviceId = (newDeviceId) => {
        deviceId = newDeviceId;
        $deviceId.innerText = deviceId;
    }
    const getDeviceId = () => {
        return deviceId;
    }

    const createLogEntryTemplate = (log) => {
        const newLogEntry = document.createElement('div');
        newLogEntry.innerText = log;
        return newLogEntry;
    }
    const appendLog = (data) => {
        const logentry = createLogEntryTemplate(data);
        $log.appendChild(logentry)
    }
    const pushToLog = (data) => {
        log.push(data);
        appendLog(data);

    }
    // When the connection is open, send some data to the server
    connection.onopen = function () {
        connection.send('AT+RST\r\n');
    };

    // Log errors
    connection.onerror = function (error) {
        console.log('WebSocket Error ' + error);
    };

    // Log messages from the server
    connection.onmessage = function (e) {
        if(e.data.startsWith('[used][readonly][rejected]')) {
            setReadOnly();
            return;
        }
        if(e.data.startsWith('[used][readonly][input]')) {
            setReadOnlySendedRequest(e.data.split('[used][readonly][input]')[1]);
            return;
        }
        if(e.data.startsWith('#start#')) {
            setBlacklist(JSON.parse(e.data.split('#start#')[1].split('#')[0].split(',')));
            setDeviceId(e.data.split('#start#')[1].split('#')[1]);
            setLan(e.data.split('#start#')[1].split('#')[2]);
            return;
        }
        pushToLog(e.data);
    };
    for (let i in window.serialConsoleIds){
        const currentConsole =  window.serialConsoleIds[i];
        if (currentConsole.id === id) {
            currentConsole.elements = elements;
            currentConsole.actions = {};
            currentConsole.actions.getReadOnlyStatus = getReadOnlyStatus;
            currentConsole.actions.getDeviceId = getDeviceId;
            currentConsole.actions.getBlacklist = getBlacklist;
            currentConsole.actions.getLan = getLan;
            currentConsole.actions.send = connection.send;
            currentConsole.actions.toggleFullLog = toggleFullLog;
        }
    }
    }, 1500);

    return {id, connectToDeviceId};
}


</script>
</body>
</html>
