<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lora Serial Interface</title>
    <style>
        .disabled{
            background: black;
            color:white;
        }
        .enabled {
            color:black;
            background: #bfbdbd;
        }
        .hidden {
            display:none;
        }
    </style>
</head>
<body>
<div id="serial-connection" class="enabled">
    <div id="readonly-label" class="readonly-label hidden">readonly</div>
    <div> Device Id:  <span id="device-id">...</span></div>
    <div> Ist im Wlan: <span id="is-lan">...</span></div>
    <div> Blacklist: <span id="blacklist">...</span></div>
    <div id="log">...</div>
    <div>
        <label for="serial-input">Input:</label>
        <input id="serial-input" />
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function(event) {
        const connection = new WebSocket('ws://localhost:8001', ['soap', 'xmpp']);
        const log = [];
        let deviceId = undefined;
        let isReadOnly = undefined;
        let blacklist = undefined;
        let lan = undefined;
        const $log = document.querySelector('#log');
        const $deviceId = document.querySelector('#device-id');
        const $readonlyLabel = document.querySelector('#readonly-label');
        const $blacklist = document.querySelector('#blacklist');
        const $lanContainer = document.querySelector('#is-lan');
        const $container = document.querySelector('#serial-connection');
        console.log($log);
        const setReadOnly = () => {
            /**
             * Upgrade Protocol
             * @type {boolean}
             */
            connection.send('@@@UPGRADE@@@');

            isReadOnly = true;
            $container.classList.add('disabled');
            $container.classList.remove('enabled');
            $readonlyLabel.classList.remove('hidden');
        }
        const setBlacklist = (newBlacklist) => {
            blacklist = newBlacklist;
            $blacklist.innerText = blacklist.join(' , ');
        }
        const setLan = (value) => {
            lan = value;
            debugger;
            if (value === 'true') {
                $lanContainer.innerHTML = '✓'
                return;
            }
            $lanContainer.innerHTML = '❌';
        }
        const setDeviceId = (newDeviceId) => {
            deviceId = newDeviceId;
            $deviceId.innerText = deviceId;
        }

        const createLogEntryTemplate = (log) => {
            const newLogEntry = document.createElement('div');
            newLogEntry.innerText = log;
            return newLogEntry;
        }
        const refreshLog = (data) => {
            const logentry = createLogEntryTemplate(data);
            $log.appendChild(logentry)
        }
        const pushToLog = (data) => {
            log.push(data);
            refreshLog(data);
            debugger;
        }
        // When the connection is open, send some data to the server
        connection.onopen = function () {
            connection.send('AT+RST\r\n');
        };

        // Log errors
        connection.onerror = function (error) {
            console.log('WebSocket Error ' + error);
        };

        // Log messages from the server
        connection.onmessage = function (e) {
            if(e.data.startsWith('[used][readonly][rejected]')) {
                setReadOnly();
                return;
            }
            if(e.data.startsWith('#start#')) {
                setBlacklist(e.data.split('#start#')[1].split('#')[0].split(','));
                setDeviceId(e.data.split('#start#')[1].split('#')[1]);
                setLan(e.data.split('#start#')[1].split('#')[2]);
                return;
            }
            pushToLog(e.data);
        };        //do work
    });

</script>
</body>
</html>
